<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SyncSlide</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="pdf-viewer">
      <h1>Welcome to SyncSlide</h1>
      <p>Emphasizes synchronized viewing of slides in real-time.</p>
      <input type="file" id="uploadPdf" accept="application/pdf">
      <div class="pdf-navigation">
        <button id="reset">New PDF</button>
        <button id="prevPage">Previous Page</button>
        <button id="nextPage">Next Page</button>
      </div>
      <div class="page-info">
        <span id="pageNum">Page 1</span> / <span id="pageCount">0</span>
      </div>
      <canvas id="pdfCanvas"></canvas>
    </div>
    <div class="page-thumbnails" id="thumbnailsContainer"></div>
  </div>

  <script>
    let pdfDoc = null;      
    let currentPage = 1;     
    let totalPages = 0;      
    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');
    const uploadPdfInput = document.getElementById('uploadPdf');
    const thumbnailsContainer = document.getElementById('thumbnailsContainer');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const socket = io();

    uploadPdfInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file && file.type === 'application/pdf') {
        const fileReader = new FileReader();
        fileReader.onload = function() {
          const pdfData = new Uint8Array(this.result);
          loadPdf(pdfData);
        };
        fileReader.readAsArrayBuffer(file);
      } else {
        alert("Please upload a valid PDF file.");
      }
    });

    function loadPdf(pdfData) {
      pdfjsLib.getDocument(pdfData).promise.then(function(pdf) {
        pdfDoc = pdf;
        totalPages = pdfDoc.numPages;
        document.getElementById('pageCount').textContent = totalPages;
        renderPage(currentPage);
        generateThumbnails();
        prevPageBtn.disabled = false;
        nextPageBtn.disabled = false;
      }).catch(function(error) {
        console.error("Error loading PDF: ", error);
        alert("Failed to load PDF. Please try again.");
      });
    }

    function renderPage(pageNum) {
      pdfDoc.getPage(pageNum).then(function(page) {
        const scale = 1.5;
        const viewport = page.getViewport({ scale: scale });
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        const renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        page.render(renderContext).promise.then(function() {
          document.getElementById('pageNum').textContent = pageNum;
          highlightThumbnail(pageNum);
        });
        socket.emit('pageChanged', pageNum);
      });
    }

    function generateThumbnails() {
      for (let i = 1; i <= totalPages; i++) {
        const thumbnailContainer = document.createElement('div');
        const thumbnail = document.createElement('canvas');
        thumbnail.classList.add('thumbnail');
        thumbnailContainer.appendChild(thumbnail);

        pdfDoc.getPage(i).then(function(page) {
          const scale = 0.2;
          const viewport = page.getViewport({ scale: scale });
          thumbnail.width = viewport.width;
          thumbnail.height = viewport.height;
          const renderContext = {
            canvasContext: thumbnail.getContext('2d'),
            viewport: viewport
          };
          page.render(renderContext);
        });

        thumbnailContainer.addEventListener('click', function() {
          currentPage = i;
          renderPage(currentPage);
        });

        thumbnailsContainer.appendChild(thumbnailContainer);
      }
    }

    function highlightThumbnail(pageNum) {
      const thumbnails = document.querySelectorAll('.thumbnail');
      thumbnails.forEach((thumbnail, index) => {
        if (index + 1 === pageNum) {
          thumbnail.classList.add('active-thumbnail');
        } else {
          thumbnail.classList.remove('active-thumbnail');
        }
      });
    }

    prevPageBtn.addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        renderPage(currentPage);
      }
    });

    nextPageBtn.addEventListener('click', function() {
      if (currentPage < totalPages) {
        currentPage++;
        renderPage(currentPage);
      }
    });

    socket.on('pageChanged', function(pageNum) {
      if (currentPage !== pageNum) {
        currentPage = pageNum;
        renderPage(currentPage);
      }
    });

    document.getElementById('reset').addEventListener('click', function () {
      const context = canvas.getContext('2d');
      context.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById('pageNum').textContent = 'Page 0';
      document.getElementById('pageCount').textContent = '0';
      thumbnailsContainer.innerHTML = '';
      pdfDoc = null;
      currentPage = 1;
      totalPages = 0;
      uploadPdfInput.value = '';
    });
  </script>
</body>
</html>
